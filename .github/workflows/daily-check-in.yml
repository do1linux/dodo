name: LinuxDo Automation

on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  automate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ========== ç³»ç»Ÿä¾èµ–å®‰è£… ==========
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 \
          libcups2 libdrm2 libxkbcommon0 libxdamage1 libxcomposite1 \
          libxrandr2 libgbm1 libpango-1.0-0 libcairo2 \
          libatspi2.0-0 libx11-xcb1 libasound2t64 \
          tesseract-ocr tesseract-ocr-chi-sim tesseract-ocr-eng \
          python3-pil python3-pip \
          libffi8 libx264-164

    # ========== æµè§ˆå™¨ç¯å¢ƒç¼“å­˜ ==========
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    # ========== åº”ç”¨çŠ¶æ€ç¼“å­˜ ==========
    - name: Cache application state
      uses: actions/cache@v4
      id: app-state-cache
      with:
        path: |
          cf_cookies.json
          browser_state.json
          session_data.json
          final_status.json
          connect_info.txt
        key: ${{ runner.os }}-app-state-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-app-state-

    # ========== Pythonç¯å¢ƒé…ç½® ==========
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Cache Python packages
      uses: actions/cache@v4
      id: pip-cache
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        if [ "${{ steps.playwright-cache.outputs.cache-hit }}" != 'true' ]; then
          python -m playwright install chromium
        fi

    # ========== æ‰§è¡Œæ ¸å¿ƒä»»åŠ¡ ==========
    - name: Run automation script
      timeout-minutes: 30
      env:
        LINUXDO_USERNAME: ${{ secrets.LINUXDO_USERNAME }}
        LINUXDO_PASSWORD: ${{ secrets.LINUXDO_PASSWORD }}
        OCR_API_KEY: ${{ secrets.OCR_API_KEY }}
        HEADLESS: 'true'
        GITHUB_ACTIONS: 'true'
      run: |
        timeout 1800s python main.py || echo "ğŸš€LinuxDoè‡ªåŠ¨åŒ–è„šæœ¬å¯åŠ¨ğŸš€"
        
        echo "=== æ‰§è¡Œç»“æœ ==="
        if [ -f "final_status.json" ]; then
          echo "æœ€ç»ˆçŠ¶æ€:"
          cat final_status.json
        fi
        
        if [ -f "connect_info.txt" ]; then
          echo "Connectä¿¡æ¯å·²ç”Ÿæˆ"
        fi

    # ========== ä¿å­˜ç¼“å­˜ ==========
    - name: Save application state cache
      uses: actions/cache/save@v4
      if: always()
      with:
        path: |
          cf_cookies.json
          browser_state.json
          session_data.json
          final_status.json
          connect_info.txt
        key: ${{ runner.os }}-app-state-${{ github.sha }}

    # ========== ç»“æœå½’æ¡£ ==========
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: automation-results
        path: |
          connect_info.txt
          cf_cookies.json
          browser_state.json
          session_data.json
          final_status.json
          *.png
          automator.log
        retention-days: 7

    # ========== çŠ¶æ€æŠ¥å‘Š ==========
    - name: Report status
      if: always()
      run: |
        echo "=== è¿è¡ŒçŠ¶æ€æŠ¥å‘Š ==="
        echo "å·¥ä½œæµ: ${{ github.workflow }}"
        echo "è¿è¡ŒID: ${{ github.run_id }}"
        echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        
        if [ -f "final_status.json" ]; then
          echo "è„šæœ¬æ‰§è¡ŒçŠ¶æ€: $(python -c "import json; data=json.load(open('final_status.json')); print(data.get('message', 'æœªçŸ¥'))")"
          echo "é‡è¯•æ¬¡æ•°: $(python -c "import json; data=json.load(open('final_status.json')); print(data.get('retry_count', 0))")"
        else
          echo "è„šæœ¬æ‰§è¡ŒçŠ¶æ€: æœªå®Œæˆæˆ–çŠ¶æ€æ–‡ä»¶ç¼ºå¤±"
        fi
        
        if [ -f "connect_info.txt" ]; then
          echo "Connectä¿¡æ¯: å·²ç”Ÿæˆ"
        else
          echo "Connectä¿¡æ¯: æœªç”Ÿæˆ"
        fi
