name: LinuxDo Daily Check-in

on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时执行一次
  workflow_dispatch:

jobs:
  run_script:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl gnupg
          # 安装Playwright依赖
          npx playwright install-deps
          
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright loguru tabulate requests
          playwright install chromium
          
      - name: Cache Python packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: Run LinuxDo automation script
        env:
          LINUXDO_USERNAME: ${{ secrets.LINUXDO_USERNAME }}
          LINUXDO_PASSWORD: ${{ secrets.LINUXDO_PASSWORD }}
          BROWSE_ENABLED: ${{ secrets.BROWSE_ENABLED }}
        run: |
          echo "开始执行LinuxDo自动化脚本..."
          # 创建缓存目录
          mkdir -p cache
          python main.py
          echo "脚本执行完成"
          
      - name: Upload cache artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linuxdo-cache
          path: cache/
          retention-days: 7
          
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            *.log
            cache/
          retention-days: 7
          
      - name: Cleanup workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 5
