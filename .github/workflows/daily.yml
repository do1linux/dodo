name: LinuxDo Multi-Site Automation with Enhanced Caching

on:
  workflow_dispatch:
    inputs:
      site_selector:
        description: 'é€‰æ‹©è¦è¿è¡Œçš„ç«™ç‚¹'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - linux_do
          - idcflare
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡

env:
  PYTHON_VERSION: '3.11'
  COOKIES_CACHE_DIR: ${{ github.workspace }}
  # å®šä¹‰ç¼“å­˜ç‰ˆæœ¬ï¼Œç”¨äºŽæ‰‹åŠ¨åˆ·æ–°ç¼“å­˜
  CACHE_VERSION: 'v1'

jobs:
  automate:
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # è¿›ä¸€æ­¥å¢žåŠ è¶…æ—¶æ—¶é—´ï¼Œé¿å…å¤æ‚æ“ä½œä¸­æ–­

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: é¢„æ£€æŸ¥ - æ˜¾ç¤ºçŽ°æœ‰ç¼“å­˜æ–‡ä»¶
      run: |
        echo "ðŸ” é¢„æ£€æŸ¥ - å½“å‰å·¥ä½œç›®å½•ä¸­çš„ç¼“å­˜æ–‡ä»¶:"
        ls -lah *.json 2>/dev/null || echo "â„¹ï¸ æœªæ‰¾åˆ°çŽ°æœ‰ç¼“å­˜æ–‡ä»¶"
        echo "----------------------------------------"

    - name: æ¢å¤Cloudflareå’Œç™»å½•çŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      id: cookies-cache
      with:
        path: |
          cf_cookies_linux_do.json
          cf_cookies_idcflare.json
          browser_state_linux_do.json
          browser_state_idcflare.json
          # æ–°å¢žCloudflareæŒ‘æˆ˜çŠ¶æ€ç¼“å­˜
          cloudflare_state_linux_do.json
          cloudflare_state_idcflare.json
          # æ–°å¢žä¼šè¯æŒ‡çº¹ç¼“å­˜
          session_fingerprint_linux_do.json
          session_fingerprint_idcflare.json
        # ä½¿ç”¨æ›´ç¨³å®šçš„ç¼“å­˜keyï¼Œä¸ä¾èµ–github.shaï¼Œé¿å…æ¯æ¬¡æäº¤éƒ½å¤±æ•ˆ
        key: ${{ runner.os }}-linuxdo-cache-${{ env.CACHE_VERSION }}-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-linuxdo-cache-${{ env.CACHE_VERSION }}-
          ${{ runner.os }}-linuxdo-cache-

    - name: æ¢å¤æµè§ˆå™¨äºŒè¿›åˆ¶ç¼“å­˜ï¼ˆåŠ é€ŸChromeå®‰è£…ï¼‰
      uses: actions/cache@v3
      id: chrome-cache
      with:
        path: |
          /usr/bin/google-chrome-stable
          /usr/bin/google-chrome
        key: ${{ runner.os }}-chrome-${{ hashFiles('**/install-chrome.sh') }}
        restore-keys: |
          ${{ runner.os }}-chrome-

    - name: æ˜¾ç¤ºç¼“å­˜æ¢å¤çŠ¶æ€
      run: |
        echo "ðŸ“¦ ç¼“å­˜æ¢å¤çŠ¶æ€æ£€æŸ¥:"
        echo "Cookiesç¼“å­˜å‘½ä¸­: ${{ steps.cookies-cache.outputs.cache-hit == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }}"
        echo "Chromeç¼“å­˜å‘½ä¸­: ${{ steps.chrome-cache.outputs.cache-hit == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }}"
        if [ "${{ steps.cookies-cache.outputs.cache-hit }}" == "true" ]; then
          echo "ç¼“å­˜æ–‡ä»¶åˆ—è¡¨:"
          ls -lah *.json 2>/dev/null || echo "âš ï¸ ç¼“å­˜å‘½ä¸­ä½†æ–‡ä»¶æœªæ‰¾åˆ°"
        fi
        echo "----------------------------------------"

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        # å¯ç”¨Pythonä¾èµ–ç¼“å­˜
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt

    - name: Install system dependencies for Chromium
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          libnss3 \
          libatk-bridge2.0-0 \
          libdrm2 \
          libxkbcommon0 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libgbm1 \
          libxss1 \
          libasound2 \
          libatspi2.0-0 \
          libcups2 \
          libx11-xcb1 \
          fonts-liberation \
          libappindicator3-1 \
          xdg-utils \
          ca-certificates \
          fonts-noto-cjk \
          fonts-noto-color-emoji
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: Install Chrome (å¸¦ç¼“å­˜æœºåˆ¶)
      run: |
        if ! command -v google-chrome &> /dev/null; then
          echo "ðŸ”§ Chromeæœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
          curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
        else
          echo "âœ… Chromeå·²å­˜åœ¨ï¼Œè·³è¿‡å®‰è£…"
        fi
        google-chrome --version

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip list
        echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"

    - name: Create turnstilePatch extension (å¢žå¼ºåæ£€æµ‹)
      run: |
        echo "ðŸ”§ åˆ›å»ºå¢žå¼ºç‰ˆturnstilePatchæ‰©å±•..."
        mkdir -p turnstilePatch
        cat > turnstilePatch/manifest.json << 'EOF'
        {
          "manifest_version": 3,
          "name": "Turnstile Patch",
          "version": "2.0",
          "description": "å¢žå¼ºç‰ˆCloudflare Turnstileåæ£€æµ‹è¡¥ä¸",
          "content_scripts": [{
            "matches": ["https://*.linux.do/*", "https://*.idcflare.com/*", "https://*.cloudflare.com/*"],
            "js": ["content.js"],
            "run_at": "document_start",
            "all_frames": true
          }],
          "permissions": ["webRequest", "webRequestBlocking", "*://*/*"]
        }
        EOF
        
        cat > turnstilePatch/content.js << 'EOF'
        // å¢žå¼ºç‰ˆCloudflare Turnstile Patch
        (function() {
          'use strict';
          
          // ç«‹å³æ‰§è¡Œï¼Œé¿å…è¢«æ£€æµ‹
          const originalQuery = window.navigator.permissions.query;
          window.navigator.permissions.query = (parameters) => {
            if (parameters && parameters.name === 'notifications') {
              return Promise.resolve({ state: Notification.permission });
            }
            return originalQuery(parameters);
          };
          
          // éšè—webdriverå±žæ€§ - å¤šé‡ä¿æŠ¤
          Object.defineProperty(navigator, 'webdriver', {
            get: () => undefined,
            configurable: false,
            enumerable: false
          });
          
          // ä¿®æ”¹pluginså±žæ€§ - æ¨¡æ‹ŸçœŸå®žæµè§ˆå™¨
          Object.defineProperty(navigator, 'plugins', {
            get: () => [1, 2, 3, 4, 5],
            configurable: false
          });
          
          // ä¿®æ”¹languageså±žæ€§
          Object.defineProperty(navigator, 'languages', {
            get: () => ['zh-CN', 'zh', 'en-US', 'en'],
            configurable: false
          });
          
          // æ·»åŠ mimeTypes
          Object.defineProperty(navigator, 'mimeTypes', {
            get: () => [1, 2],
            configurable: false
          });
          
          // ä¼ªé€ chromeå¯¹è±¡
          window.chrome = {
            runtime: {
              PlatformOs: { LINUX: 'linux', MAC: 'mac', WIN: 'win' },
              PlatformArch: { ARM: 'arm', X86_32: 'x86_32', X86_64: 'x86_64' },
              PlatformNaclArch: { ARM: 'arm', X86_32: 'x86_32', X86_64: 'x86_64' },
              RequestUpdateCheckStatus: { THROTTLED: 'throttled', NO_UPDATE: 'no_update', UPDATE_AVAILABLE: 'update_available' },
              LastError: {}
            },
            loadTimes: () => ({}),
            csi: () => ({ onloadT: 0, pageT: 0 }),
            app: {},
            webstore: {},
            management: {}
          };
          
          // ä¼ªé€ performance
          if (typeof performance !== 'undefined') {
            const originalNow = performance.now;
            performance.now = function() {
              return originalNow.call(this) + Math.random() * 100;
            };
          }
          
          // æ¨¡æ‹Ÿé¼ æ ‡ç§»åŠ¨ç—•è¿¹
          document.addEventListener('mousemove', (e) => {
            window.lastMouseX = e.screenX;
            window.lastMouseY = e.screenY;
          });
          
          console.log('ðŸ”§ å¢žå¼ºç‰ˆTurnstile Patch å·²æ³¨å…¥');
          
          // å®šæœŸé‡å®šä¹‰ï¼Œé˜²æ­¢è¢«è¦†ç›–
          setInterval(() => {
            Object.defineProperty(navigator, 'webdriver', {
              get: () => undefined,
            });
          }, 5000);
        })();
        EOF
        
        # åˆ›å»ºèƒŒæ™¯è„šæœ¬è¿›ä¸€æ­¥éšè—æ‰©å±•
        cat > turnstilePatch/background.js << 'EOF'
        // éšè—æ‰©å±•èº«ä»½
        chrome.runtime.onInstalled.addListener(() => {
          console.log('Turnstile Patch installed');
        });
        
        // ä¼ªè£…æ‰©å±•ID
        chrome.management.getSelf((info) => {
          if (info && info.installType === 'development') {
            console.log('Extension is in development mode');
          }
        });
        EOF
        
        echo "âœ… å¢žå¼ºç‰ˆæ‰©å±•åˆ›å»ºå®Œæˆ"
        echo "ðŸ“¦ æ‰©å±•ç»“æž„:"
        ls -R turnstilePatch/

    - name: åˆå§‹åŒ–ç¼“å­˜ç›®å½•å’Œæƒé™
      run: |
        echo "ðŸ“ åˆå§‹åŒ–ç¼“å­˜ç›®å½•..."
        # ç¡®ä¿å½“å‰å·¥ä½œç›®å½•æœ‰æ­£ç¡®çš„æƒé™
        sudo chmod -R 777 ${{ github.workspace }}
        # åœ¨å·¥ä½œç›®å½•åˆ›å»ºç¼“å­˜è®°å½•æ–‡ä»¶
        echo '{"last_run":"'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'", "version":"'${{ env.CACHE_VERSION }}'"}' > cache_metadata.json
        echo "âœ… ç¼“å­˜å…ƒæ•°æ®å·²åˆ›å»º"

    - name: Run automation script with enhanced caching
      env:
        LINUXDO_USERNAME: ${{ secrets.LINUXDO_USERNAME }}
        LINUXDO_PASSWORD: ${{ secrets.LINUXDO_PASSWORD }}
        IDCFLARE_USERNAME: ${{ secrets.IDCFLARE_USERNAME }}
        IDCFLARE_PASSWORD: ${{ secrets.IDCFLARE_PASSWORD }}
        GITHUB_ACTIONS: 'true'
        DOH_SERVER: 'https://ld.ddd.oaifree.com/query-dns'
        SITE_SELECTOR: ${{ github.event.inputs.site_selector || 'all' }}
        # æ–°å¢žçŽ¯å¢ƒå˜é‡æŽ§åˆ¶ç¼“å­˜è¡Œä¸º
        CACHE_VERSION: ${{ env.CACHE_VERSION }}
        FORCE_REFRESH_CACHE: ${{ secrets.FORCE_REFRESH_CACHE || 'false' }}
      run: |
        echo "========================================"
        echo "ðŸš€ å¼€å§‹æ‰§è¡Œå¢žå¼ºç‰ˆè‡ªåŠ¨åŒ–è„šæœ¬"
        echo "ç«™ç‚¹é€‰æ‹©: $SITE_SELECTOR"
        echo "å½“å‰æ—¶é—´: $(date)"
        echo "DoHæœåŠ¡å™¨: $DOH_SERVER"
        echo "ç¼“å­˜ç‰ˆæœ¬: $CACHE_VERSION"
        echo "å¼ºåˆ¶åˆ·æ–°ç¼“å­˜: $FORCE_REFRESH_CACHE"
        echo "Cookiesç¼“å­˜å‘½ä¸­: ${{ steps.cookies-cache.outputs.cache-hit == 'true' && 'æ˜¯' || 'å¦' }}"
        echo "========================================"
        
        # æ˜¾ç¤ºå½“å‰ç¼“å­˜æ–‡ä»¶çŠ¶æ€
        echo "ðŸ“¦ å½“å‰ç¼“å­˜æ–‡ä»¶çŠ¶æ€:"
        ls -lah *.json 2>/dev/null || echo "â„¹ï¸ æœªæ‰¾åˆ°ç¼“å­˜æ–‡ä»¶"
        echo "----------------------------------------"
        
        python main.py
        
        echo "========================================"
        echo "âœ… è„šæœ¬æ‰§è¡Œå®Œæˆ"
        echo "ðŸ“¦ æœ€ç»ˆç¼“å­˜æ–‡ä»¶çŠ¶æ€:"
        ls -lah *.json 2>/dev/null || echo "â„¹ï¸ æœªç”Ÿæˆæ–°çš„ç¼“å­˜æ–‡ä»¶"
        echo "========================================"

    - name: éªŒè¯å’Œä¿®å¤ç¼“å­˜æ–‡ä»¶æƒé™
      if: always()
      run: |
        echo "ðŸ”§ éªŒè¯ç¼“å­˜æ–‡ä»¶æƒé™..."
        if [ -f "cf_cookies_linux_do.json" ]; then
          sudo chmod 644 cf_cookies_linux_do.json
          echo "âœ… ä¿®å¤ cf_cookies_linux_do.json æƒé™"
        fi
        if [ -f "cf_cookies_idcflare.json" ]; then
          sudo chmod 644 cf_cookies_idcflare.json
          echo "âœ… ä¿®å¤ cf_cookies_idcflare.json æƒé™"
        fi
        # æ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶çŠ¶æ€
        echo "ðŸ“‹ æœ€ç»ˆç¼“å­˜æ–‡ä»¶çŠ¶æ€:"
        ls -lah *.json 2>/dev/null || echo "â„¹ï¸ æ— ç¼“å­˜æ–‡ä»¶"

    - name: Upload session and cache data (å…³é”®å¤‡ä»½)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: session-cache-data-${{ github.run_number }}
        path: |
          cf_cookies_linux_do.json
          cf_cookies_idcflare.json
          browser_state_linux_do.json
          browser_state_idcflare.json
          cloudflare_state_linux_do.json
          cloudflare_state_idcflare.json
          session_fingerprint_linux_do.json
          session_fingerprint_idcflare.json
          cache_metadata.json
          # åŒ…å«è°ƒè¯•ç”¨HTML
          connect_debug_*.html
          login_debug_*.html
          login_error_*.html
        retention-days: 30  # å»¶é•¿ä¿ç•™æ—¶é—´
        overwrite: false  # ä¿ç•™åŽ†å²ç‰ˆæœ¬
        compression-level: 9  # æœ€å¤§åŽ‹ç¼©èŠ‚çœç©ºé—´

    - name: æ¸…ç†ä¸´æ—¶è°ƒè¯•æ–‡ä»¶
      if: always()
      run: |
        echo "ðŸ§¹ æ¸…ç†ä¸´æ—¶è°ƒè¯•æ–‡ä»¶ (ä¿ç•™æ ¸å¿ƒç¼“å­˜)..."
        # åªåˆ é™¤HTMLè°ƒè¯•æ–‡ä»¶ï¼Œä¿ç•™æ‰€æœ‰JSONç¼“å­˜
        find . -name "connect_debug_*.html" -type f -delete
        find . -name "login_debug_*.html" -type f -delete
        find . -name "login_error_*.html" -type f -delete
        
        # æ˜¾ç¤ºå‰©ä½™çš„ç¼“å­˜æ–‡ä»¶
        echo "ðŸ“¦ ä¿ç•™çš„æ ¸å¿ƒç¼“å­˜æ–‡ä»¶:"
        ls -lah *.json 2>/dev/null || echo "â„¹ï¸ æ— ç¼“å­˜æ–‡ä»¶"

    - name: æ›´æ–°ç¼“å­˜å…ƒæ•°æ®
      if: always()
      run: |
        echo "ðŸ“ æ›´æ–°ç¼“å­˜å…ƒæ•°æ®..."
        cat > cache_metadata.json << EOF
        {
          "last_run": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "cache_version": "${{ env.CACHE_VERSION }}",
          "run_id": "${{ github.run_id }}",
          "run_number": "${{ github.run_number }}",
          "success": "${{ job.status == 'success' }}",
          "sites_processed": "${{ env.SITE_SELECTOR || 'all' }}"
        }
        EOF
        cat cache_metadata.json
